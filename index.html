<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonogram odbioru odpad贸w Kobylanka 2026</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        select, input { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            font-size: 16px; 
        }
        #loading { 
            color: #666; 
        }
        #dates { 
            background: #f5f5f5; 
            padding: 20px; 
            border-radius: 8px; 
        }
        .nearest { 
            font-size: 2em; 
            font-weight: bold; 
            color: #d32f2f; 
            background: #ffebee; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
        }
        ul { 
            list-style-type: none; 
            padding: 0; 
        }
        li { 
            padding: 5px 0; 
            border-bottom: 1px solid #ddd; 
        }
        .error { 
            color: #d32f2f; 
        }
        h1 { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .waste-type { 
            background: #2196f3; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 0.8em; }
        .warning {
            background-color: #FDF7DF;
            border: 1px solid #FEEC6F;
            padding: 5px 10px; 
            color: #C9971C;
        }
        /* Styled export button */
        .export-btn {
            display: block;
            width: 100%;
            margin-top: 10px;
            padding: 14px 18px;
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            background: linear-gradient(90deg,#4caf50 0%,#2e7d32 100%);
            border: none;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(46,125,50,0.18);
            cursor: pointer;
            transition: transform .12s ease, box-shadow .12s ease, opacity .12s;
            text-align: center;
        }
        .export-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(46,125,50,0.22); }
        .export-btn:active { transform: translateY(-1px); }
        .export-btn:disabled { opacity: 0.65; cursor: not-allowed; transform: none; box-shadow: none; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
</head>
<body>
    <a class="github-fork-ribbon" href="https://github.com/alchemyx/odpady-kobylanka" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <div class="warning">Strona niepowizana z gmin Kobylanka, <em>mo偶e zawiera bdy</em>.<br/>Informacje pobrane ze strony <a href="https://kobylanka.pl/gospodarka-odpadami/harmonogram-odbioru-odpadow-komunalnych/">Harmonogram odbioru odpad贸w komunalnych</a><br/>Kontakt do autora info(mapka)kobylanka(kropka)net</div>
    <h1>
        <span>Harmonogram odbioru odpad贸w Kobylanka 2026</span>
        <span id="wasteTypeLabel" class="waste-type">Zmieszane</span>
    </h1>
    
    <select id="wasteTypeSelect">
        <option value="odpady-zmieszane.csv">Zmieszane</option>
        <option value="odpady-bio.csv">Bio</option>
        <option value="odpady-selektywne.csv">Selektywne</option>
    </select>
    
    <div id="loading">adowanie danych...</div>
    <select id="townSelect" disabled>
        <option value="">Wybierz lokalizacj...</option>
    </select>
    <button id="exportBtn" class="export-btn" style="display:none"> Eksportuj do Kalendarza (.ics)</button>
    <div id="dates" style="display: none;">
        <h3>Daty dla wybranej lokalizacji:</h3>
        <div id="nearestDate" class="nearest"></div>
        <ul id="dateList"></ul>
    </div>

    <script>
        const wasteTypeSelect = document.getElementById('wasteTypeSelect');
        const wasteTypeLabel = document.getElementById('wasteTypeLabel');
        const townSelect = document.getElementById('townSelect');
        const datesDiv = document.getElementById('dates');
        const nearestDiv = document.getElementById('nearestDate');
        const dateList = document.getElementById('dateList');
        const loadingDiv = document.getElementById('loading');
        const exportBtn = document.getElementById('exportBtn');

        let data = [];
        let currentFile = 'odpady-zmieszane.csv';

        // Mapa nazw plik贸w na etykiety
        const fileLabels = {
            'odpady-zmieszane.csv': 'Zmieszane',
            'odpady-bio.csv': 'Bio',
            'odpady-selektywne.csv': 'Selektywne'
        };

        wasteTypeSelect.addEventListener('change', function() {
            currentFile = this.value;
            wasteTypeLabel.textContent = fileLabels[currentFile];
            loadCSV();
        });

        // Automatyczne adowanie przy starcie
        loadCSV();

        function loadCSV() {
            loadingDiv.style.display = 'block';
            loadingDiv.textContent = `adowanie ${fileLabels[currentFile]}...`;
            townSelect.disabled = true;
            townSelect.value = '';
            datesDiv.style.display = 'none';

            fetch(currentFile)
                .then(response => {
                    if (!response.ok) throw new Error(`Nie znaleziono ${currentFile}`);
                    return response.text();
                })
                .then(parseCSV)
                .catch(error => {
                    loadingDiv.innerHTML = `<span class="error">Bd: ${error.message}</span>`;
                    townSelect.disabled = true;
                    exportBtn.style.display = 'none';
                    exportBtn.disabled = true;
                });
        }

        function parseCSV(text) {
            data = text.split('\n').map(line => {
                if (!line.trim()) return null;
                const parts = line.split('|');
                const town = parts[0].trim();
                const rest = parts.slice(1).join('|').trim();
                const datesStr = rest.replace(/[^\d\-]/g, '');
                const dates = [];
                for (let i = 0; i < datesStr.length; i += 10) {
                    const dateStr = datesStr.substr(i, 10);
                    if (dateStr.match(/\d{4}-\d{2}-\d{2}/)) {
                        dates.push(dateStr);
                    }
                }
                return { town, dates };
            }).filter(Boolean);

            const uniqueTowns = [...new Set(data.map(row => row.town))].sort();

            townSelect.innerHTML = '<option value="">Wybierz lokalizacj...</option>';
            uniqueTowns.forEach(town => {
                const option = document.createElement('option');
                option.value = town;
                option.textContent = town;
                townSelect.appendChild(option);
            });
            townSelect.disabled = false;
            loadingDiv.style.display = 'none';
            exportBtn.style.display = 'none';
            exportBtn.disabled = true;
        }

        townSelect.addEventListener('change', function() {
            const selectedTown = this.value;
            const townData = data.find(row => row.town === selectedTown);
            if (!townData) return;

            // Enable export button when a town with dates is selected
            if (townData.dates && townData.dates.length) {
                exportBtn.style.display = 'inline-block';
                exportBtn.disabled = false;
            } else {
                exportBtn.style.display = 'none';
                exportBtn.disabled = true;
            }
            
            const now = new Date();
            let nearest = null;
            let minDiff = Infinity;

            townData.dates.forEach(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                if (date > now) {
                    const diff = date - now;
                    if (diff < minDiff) {
                        minDiff = diff;
                        nearest = dateStr;
                    }
                }
            });

            dateList.innerHTML = '';
            townData.dates.forEach(dateStr => {
                const li = document.createElement('li');
                li.textContent = dateStr;
                dateList.appendChild(li);
            });

            if (nearest) {
                nearestDiv.textContent = `NAJBLI呕SZY TERMIN: ${nearest} (za ${Math.round(minDiff / (1000*60*60*24))} dni)`;
            } else {
                nearestDiv.textContent = 'Brak przyszych termin贸w.';
            }

            datesDiv.style.display = 'block';
        });
        
        // Generate an iCalendar (.ics) string for all-day events
        function formatDateForICS(dateStr) {
            // dateStr expected as YYYY-MM-DD
            return dateStr.replace(/-/g, '');
        }
        
        function generateICS(town, dates, title) {
            const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            let ics = [];
            ics.push('BEGIN:VCALENDAR');
            ics.push('VERSION:2.0');
            ics.push('PRODID:-//odpady-kobylanka//EN');
            ics.push('CALSCALE:GREGORIAN');

            dates.forEach((d, i) => {
                const start = formatDateForICS(d);
                // DTEND for all-day events in iCal is the day after the event
                const dateObj = new Date(d + 'T00:00:00');
                const nextDay = new Date(dateObj.getTime() + 24*60*60*1000);
                const yyyy = nextDay.getFullYear();
                const mm = String(nextDay.getMonth()+1).padStart(2,'0');
                const dd = String(nextDay.getDate()).padStart(2,'0');
                const dtend = `${yyyy}${mm}${dd}`;

                ics.push('BEGIN:VEVENT');
                ics.push(`UID:${Date.now()}-${i}@odpady-kobylanka`);
                ics.push(`DTSTAMP:${dtstamp}`);
                ics.push(`SUMMARY:${title}`);
                ics.push(`DTSTART;VALUE=DATE:${start}`);
                ics.push(`DTEND;VALUE=DATE:${dtend}`);
                ics.push(`DESCRIPTION:Odbi贸r odpad贸w - ${title} (${town})`);
                ics.push('END:VEVENT');
            });

            ics.push('END:VCALENDAR');
            return ics.join('\r\n');
        }

        exportBtn.addEventListener('click', function() {
            const selectedTown = townSelect.value;
            if (!selectedTown) return;
            const townData = data.find(row => row.town === selectedTown);
            if (!townData || !townData.dates.length) return;

            const title = fileLabels[currentFile] || 'Odbi贸r odpad贸w';
            const icsContent = generateICS(selectedTown, townData.dates, title);
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const safeTown = selectedTown.replace(/[^a-z0-9_-]/ig, '_');
            const safeTitle = title.replace(/[^a-z0-9_-]/ig, '_');
            const filename = `odpady-${safeTown}-${safeTitle}.ics`;

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
