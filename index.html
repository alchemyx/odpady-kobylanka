<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonogram odbioru odpad√≥w Kobylanka 2026</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
        }
        #loading { color: #666; }
        #dates {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .nearest {
            font-size: 2em;
            font-weight: bold;
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        ul { list-style-type: none; padding: 0; }
        li { padding: 5px 0; border-bottom: 1px solid #ddd; }
        .error { color: #d32f2f; }
        h1 { display: flex; align-items: center; gap: 10px; }
        .waste-type {
            background: #2196f3;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .warning {
            background-color: #FDF7DF;
            border: 1px solid #FEEC6F;
            padding: 10px;
            margin-bottom: 10px;
            color: #C9971C;
        }
        #calendarBtn {
            display:none;
            width:100%;
            padding:12px;
            margin-bottom:10px;
            background:#4caf50;
            color:white;
            border:none;
            border-radius:8px;
            cursor:pointer;
            font-size:16px;
        }
        #calendarBtn:hover { background:#449d48; }
    </style>
</head>
<body>
<div class="warning">
    Strona niepowiƒÖzana z gminƒÖ Kobylanka. Mo≈ºe zawieraƒá b≈Çƒôdy.
</div>
<h1>
    <span>Harmonogram odbioru odpad√≥w Kobylanka 2026</span>
    <span id="wasteTypeLabel" class="waste-type">Zmieszane</span>
</h1>

<select id="wasteTypeSelect">
    <option value="odpady-zmieszane.csv">Zmieszane</option>
    <option value="odpady-bio.csv">Bio</option>
    <option value="odpady-selektywne.csv">Selektywne</option>
</select>

<div id="loading">≈Åadowanie danych...</div>
<select id="townSelect" disabled>
    <option value="">Wybierz lokalizacjƒô...</option>
</select>
<button id="calendarBtn">üìÖ Dodaj do kalendarza (ICS)</button>
<div id="dates" style="display:none;">
    <h3>Daty dla wybranej lokalizacji:</h3>
    <div id="nearestDate" class="nearest"></div>
    <ul id="dateList"></ul>
</div>

<script>
    const wasteTypeSelect = document.getElementById('wasteTypeSelect');
    const wasteTypeLabel = document.getElementById('wasteTypeLabel');
    const townSelect = document.getElementById('townSelect');
    const datesDiv = document.getElementById('dates');
    const nearestDiv = document.getElementById('nearestDate');
    const dateList = document.getElementById('dateList');
    const loadingDiv = document.getElementById('loading');
    const calendarBtn = document.getElementById("calendarBtn");

    let data = [];
    let currentFile = 'odpady-zmieszane.csv';

    const fileLabels = {
        'odpady-zmieszane.csv': 'Zmieszane',
        'odpady-bio.csv': 'Bio',
        'odpady-selektywne.csv': 'Selektywne'
    };

    const icsColors = {
        'Zmieszane': '#E53935',
        'Bio': '#43A047',
        'Selektywne': '#1E88E5'
    };

    wasteTypeSelect.addEventListener('change', () => {
        currentFile = wasteTypeSelect.value;
        wasteTypeLabel.textContent = fileLabels[currentFile];
        loadCSV();
    });

    loadCSV();

    function loadCSV() {
        loadingDiv.style.display = 'block';
        loadingDiv.textContent = `≈Åadowanie ${fileLabels[currentFile]}...`;

        townSelect.disabled = true;
        datesDiv.style.display = 'none';

        fetch(currentFile)
            .then(r => {
                if (!r.ok) throw new Error(`Nie znaleziono ${currentFile}`);
                return r.text();
            })
            .then(parseCSV)
            .catch(err => {
                loadingDiv.innerHTML = `<span class="error">${err.message}</span>`;
            });
    }

    function parseCSV(text) {
        data = text.split("\n").map(line => {
            if (!line.trim()) return null;

            const town = line.split("|")[0].trim();
            const dates = line.match(/\d{4}-\d{2}-\d{2}/g) || [];

            return { town, dates };
        }).filter(Boolean);

        const uniqueTowns = [...new Set(data.map(r => r.town))].sort();
        townSelect.innerHTML = '<option value="">Wybierz lokalizacjƒô...</option>';

        uniqueTowns.forEach(town => {
            const opt = document.createElement("option");
            opt.value = town;
            opt.textContent = town;
            townSelect.appendChild(opt);
        });

        townSelect.disabled = false;
        loadingDiv.style.display = 'none';
    }
        townSelect.addEventListener('change', () => {
        const selectedTown = townSelect.value;
        const townData = data.find(r => r.town === selectedTown);
        if (!townData) return;

        const now = new Date();
        let nearest = null;
        let minDiff = Infinity;

        townData.dates.forEach(d => {
            const date = new Date(d + "T00:00:00");
            if (date > now) {
                const diff = date - now;
                if (diff < minDiff) {
                    minDiff = diff;
                    nearest = d;
                }
            }
        });

        dateList.innerHTML = "";
        townData.dates.forEach(d => {
            const li = document.createElement("li");
            li.textContent = d;
            dateList.appendChild(li);
        });

        nearestDiv.textContent =
            nearest
                ? `NAJBLI≈ªSZY TERMIN: ${nearest} (za ${Math.ceil(minDiff / 86400000)} dni)`
                : "Brak przysz≈Çych termin√≥w.";

        datesDiv.style.display = "block";

        calendarBtn.style.display = "block";
    });


    /* GENERATOR ICS + alarm i kolor  */

    function generateICS(town, dates) {
        let type = fileLabels[currentFile]; 
        let color = icsColors[type];

        let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\nPRODID:-//kobylanka//odpady//PL\n";

        dates.forEach(dateStr => {
            const dt = dateStr.replace(/-/g, "");

            // alarm 1 dzie≈Ñ wcze≈õniej o 18:00 (na apple 19:00 ;) )
            const d = new Date(dateStr + "T00:00:00");
            d.setDate(d.getDate() - 1);
            d.setHours(18, 0, 0);

            const alert =
                d.getFullYear().toString().padStart(4, '0') +
                String(d.getMonth() + 1).padStart(2, '0') +
                String(d.getDate()).padStart(2, '0') +
                "T" +
                String(d.getHours()).padStart(2, '0') +
                String(d.getMinutes()).padStart(2, '0') +
                "00";
// Apple calendar widoczny alert 
// dla google + apple trzeba uzyc TRIGGER:-P1D (alert nie jest widoczny w wydarzeniu ale podobno dziala tak samo)
ics +=
`BEGIN:VEVENT
DTSTART;VALUE=DATE:${dt}
SUMMARY:Odbi√≥r odpad√≥w ‚Äì ${type} (${town})
COLOR:${color}
BEGIN:VALARM
TRIGGER;VALUE=DATE-TIME:${alert}
ACTION:DISPLAY
DESCRIPTION:Przypomnienie: jutro odbi√≥r odpad√≥w ‚Äì ${type}
END:VALARM
END:VEVENT
`;
        });

        ics += "END:VCALENDAR";
        return ics;
    }

    /* button ICS */

    calendarBtn.addEventListener("click", () => {
        const town = townSelect.value;
        const townData = data.find(r => r.town === town);
        if (!townData) return;

        const ics = generateICS(town, townData.dates);

        const blob = new Blob([ics], { type: "text/calendar" });
        const url = URL.createObjectURL(blob);

        window.location.href = url; // automatyczne otwarcie ICS
    });

</script>

</body>
</html>
